<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–º–ø–∞–Ω–∏—è: –ë–∏—Ç–≤–∞</title>
    <link rel="stylesheet" href="css/campaign-battle.css">
</head>

<body>
<a href="/" id="backBtn">‚¨Ö –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
<h1>‚öî –ö–∞–º–ø–∞–Ω–∏—è: –ë–∏—Ç–≤–∞</h1>

<div class="battle-container" id="battleContainer">
    <div class="unitEntity" id="playerUnitEntity">
        <img id="playerImg" src="" alt="Player">
        <div class="health-bar"><div class="health-bar-inner" id="playerHealth"></div></div>
        <div id="playerName"></div>
    </div>

    <div class="unitEntity" id="enemyUnit">
        <img id="enemyImg" src="" alt="Enemy">
        <div class="health-bar"><div class="health-bar-inner" id="enemyHealth"></div></div>
        <div id="enemyName"></div>
    </div>
</div>

<button id="attackBtn">–ê—Ç–∞–∫–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é —á–∞—Å—Ç—å</button>
<div id="log"></div>

<script>
    const logEl = document.getElementById('log');
    const playerHealthEl = document.getElementById('playerHealth');
    const enemyHealthEl = document.getElementById('enemyHealth');
    const enemyUnitEl = document.getElementById('enemyUnit');
    let selectedBody = 'CHEST';
    let zones = [];

    // --- WebSocket –∫–æ–º–ø–∞–Ω–∏–∏---
    const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const ws = new WebSocket(`${protocol}://${window.location.host}/ws/campaign`);


    ws.onopen = () => {
        logEl.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –ó–∞–ø—É—Å–∫ –∫–∞–º–ø–∞–Ω–∏–∏...';
        ws.send(JSON.stringify({ action: 'start' }));
    };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log(data);
        if(data.error){
            logEl.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + data.error;
            return;
        }

        const player = data.player;
        const enemy = data.enemy;

        // --- –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏ –∑–¥–æ—Ä–æ–≤—å–µ ---
        document.getElementById('playerImg').src = player.imagePath;
        document.getElementById('playerName').textContent = player.name;
        playerHealthEl.style.width = (player.health / player.maxHealth * 100) + '%';

        document.getElementById('enemyImg').src = enemy.imagePath;
        document.getElementById('enemyName').textContent = enemy.name;
        enemyHealthEl.style.width = (enemy.health / enemy.maxHealth * 100) + '%';

        // --- –õ–æ–≥ ---
        if(data.message) logEl.textContent = data.message;

        // --- –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫–∏ –∞—Ç–∞–∫–∏ ---
        zones.forEach(z => z.remove());
        zones = [];
        if(enemy.hitZones){
            enemy.hitZones.forEach(hz => {
                const div = document.createElement('div');
                div.classList.add('hit-zone');
                div.dataset.body = hz.body;
                div.style.top = hz.top;
                div.style.left = hz.left;
                div.style.width = hz.width;
                div.style.height = hz.height;
                div.style.background = hz.color || 'red';
                enemyUnitEl.appendChild(div);
                zones.push(div);

                div.addEventListener('click', () => {
                    zones.forEach(z => z.classList.remove('selected'));
                    div.classList.add('selected');
                    selectedBody = div.dataset.body;
                    logEl.textContent = `üéØ –¶–µ–ª—å –≤—ã–±—Ä–∞–Ω–∞: ${selectedBody}`;
                });
            });
        }
    };

    ws.onclose = () => logEl.textContent = '‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ';
    ws.onerror = (e) => logEl.textContent = '‚ùå –û—à–∏–±–∫–∞ WS: ' + e;

    // --- –ö–Ω–æ–ø–∫–∞ –∞—Ç–∞–∫–∏ ---
    document.getElementById('attackBtn').addEventListener('click', () => {
        if(ws.readyState !== WebSocket.OPEN){
            logEl.textContent = '‚ùå WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω';
            return;
        }
        ws.send(JSON.stringify({ action: 'attack', body: selectedBody }));
    });
</script>

</body>
</html>
