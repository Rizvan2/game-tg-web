<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Duel Test Fixed</title>
    <link rel="stylesheet" href="css/duel-battle.css">

</head>

<body>


<div class="battle-container">
    <div class="unitEntity" id="player1">
        <img id="player1Img" src="" alt="Player 1">
        <div class="health-bar"><div class="health-bar-inner" id="player1Health"></div></div>
        <div id="player1Name">–ü–ª–µ–µ—Ä 1</div>
    </div>
    <div class="unitEntity" id="player2">
        <img id="player2Img" src="" alt="Player 2">
        <div class="health-bar"><div class="health-bar-inner" id="player2Health"></div></div>
        <div id="player2Name">–ü–ª–µ–µ—Ä 2</div>
    </div>
</div>

<!-- –ù–∏–∂–Ω–∏–π –±–æ–ª—å—à–æ–π –±–∞—Ä —Å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π –¥–ª—è –≤—ã–±–æ—Ä–∞ –∞—Ç–∞–∫ -->
<div id="attackSection" style="width: 100%; background: #111; padding: 10px 0; display: flex; justify-content: center; margin-bottom: 10px;">
    <div class="unitEntity" style="position: relative; width: 112px; height: 300px;"> <!-- —É–∂–µ –∏ –¥–ª–∏–Ω–Ω–µ–µ -->
        <img id="attackBody" src="images/body.png" class="body-img" alt="–í—ã–±–æ—Ä –∞—Ç–∞–∫–∏"
             style="width: 100%; height: 100%; object-fit: cover; display: block;"> <!-- —Ä–∞—Å—Ç—è–Ω—É—Ç—å –Ω–∞ –≤–µ—Å—å –±–ª–æ–∫ -->

        <!-- –ó–æ–Ω—ã –ø–æ–ø–∞–¥–∞–Ω–∏—è –Ω–∞ —Ç–µ–ª–µ -->
        <div class="hit-zone" data-part="HEAD" style="top:3px; left:42px; width:22px; height:30px;"></div>
        <div class="hit-zone" data-part="CHEST" style="top:15%; left:37%; width:25%; height:22%;"></div>
        <div class="hit-zone" data-part="LEFT_ARM" style="top:25%; left:6%; width:15%; height:20%;"></div>
        <div class="hit-zone" data-part="RIGHT_ARM" style="top:25%; left:79%; width:15%; height:20%;"></div>
        <div class="hit-zone" data-part="LEFT_LEG" style="top:55%; left:28%; width:18%; height:22%;"></div>
        <div class="hit-zone" data-part="RIGHT_LEG" style="top:55%; left:54%; width:18%; height:22%;"></div>

        <!-- –ö–Ω–æ–ø–∫–∞ –∞—Ç–∞–∫–∏ –ø–æ–¥ –∫–∞—Ä—Ç–∏–Ω–∫–æ–π -->
        <button id="attackBtn" class="action-btn" style="margin-top: 15px; width: 100%; padding: 15px;">‚öîÔ∏è –ê—Ç–∞–∫–æ–≤–∞—Ç—å</button>
    </div>

</div>
<button id="toggleLogBtn" class="log-toggle">‚ò∞ –õ–æ–≥</button>

<div id="log"></div>
<button id="toggleChatBtn" class="chat-toggle">üí¨ –ß–∞—Ç</button>

<div id="chat">
    <div id="chatMessages"></div>
    <div id="chatInputBox">
        <input id="chatInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
        <button id="sendChatBtn">‚û§</button>
    </div>
</div>
<script>

    // ====== –ö–ù–û–ü–ö–ò –û–¢–ö–†–´–¢–ò–Ø –ü–ê–ù–ï–õ–ï–ô ======
    document.getElementById("toggleLogBtn").onclick = () => {
        const log = document.getElementById("log");
        log.classList.toggle("open");
        // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
        document.getElementById("toggleLogBtn").classList.toggle("hidden", log.classList.contains("open"));
    };

    document.getElementById("toggleChatBtn").onclick = () => {
        const chat = document.getElementById("chat");
        const box = document.getElementById("chatInputBox");

        chat.classList.toggle("open");
        box.style.right = chat.classList.contains("open") ? "0" : "-260px";
        // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
        document.getElementById("toggleChatBtn").classList.toggle("hidden", chat.classList.contains("open"));
    };
    // ====== –ö–õ–ò–ö–ò –í–ù–ï –ü–ê–ù–ï–õ–ï–ô ======
    document.addEventListener('click', (e) => {
        const log = document.getElementById("log");
        const logBtn = document.getElementById("toggleLogBtn");
        if (log.classList.contains("open") && !log.contains(e.target) && e.target !== logBtn) {
            log.classList.remove("open");
            logBtn.classList.remove("hidden");
        }

        const chat = document.getElementById("chat");
        const chatBtn = document.getElementById("toggleChatBtn");
        const chatMessages = document.getElementById("chatMessages");
        const chatInputBox = document.getElementById("chatInputBox");
        if (
            chat.classList.contains("open") &&
            !chatMessages.contains(e.target) &&
            !chatInputBox.contains(e.target) &&
            e.target !== chatBtn
        ) {
            chat.classList.remove("open");
            chatInputBox.style.right = "-260px";
            chatBtn.classList.remove("hidden");
        }
    });





    // ====== –§–£–ù–ö–¶–ò–ò –°–û–û–ë–©–ï–ù–ò–ô ======
    function chatMsg(msg) {
        const chatMessages = document.getElementById("chatMessages");
        const time = new Date().toLocaleTimeString();
        chatMessages.innerHTML += `<div>[${time}] ${msg}</div>`;
        chatMessages.scrollTop = chatMessages.scrollHeight; // –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –±–ª–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
    }


    function log(msg) {
        const logEl = document.getElementById("log");
        const time = new Date().toLocaleTimeString();
        logEl.innerHTML += `<div>[${time}] ${msg}</div>`;
        logEl.scrollTop = logEl.scrollHeight;
    }


    // ====== WEBSOCKET –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï ======
    const params = new URLSearchParams(window.location.search);
    const gameCode = params.get('gameCode') || params.get('id');
    const playerName = params.get('player') || localStorage.getItem('playerName') || `Player${Math.floor(Math.random()*1000)}`;
    localStorage.setItem('playerName', playerName);

    const wsProtocol = location.protocol === 'https:' ? 'wss' : 'ws';
    let ws = null;
    let wsConnected = false;

    try {
        ws = new WebSocket(`${wsProtocol}://${location.host}/ws/duel?gameCode=${encodeURIComponent(gameCode)}`);
    } catch (e) {
        log("‚ùå –û—à–∏–±–∫–∞: WebSocket –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω.");
    }


    // ====== –û–¢–ü–†–ê–í–ö–ê –ß–ê–¢–ê ======
    document.getElementById("sendChatBtn").onclick = () => {
        if (!wsConnected) {
            chatMsg("‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å: –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.");
            return;
        }

        const input = document.getElementById("chatInput");
        const text = input.value.trim();
        if (!text) return;

        ws.send(JSON.stringify({ type: "chat", message: text }));
        input.value = "";
    };

    document.getElementById("chatInput").addEventListener("keydown", e => {
        if (e.key === "Enter") {
            document.getElementById("sendChatBtn").click();
        }
    });


    // ====== –õ–û–ì–ò–ö–ê –í–´–ë–û–†–ê –ß–ê–°–¢–ò –¢–ï–õ–ê ======
    let selectedBody = null;

    document.querySelectorAll('.hit-zone').forEach(zone => {
        zone.addEventListener('click', () => {
            document.querySelectorAll('.hit-zone').forEach(z => z.classList.remove('selected'));
            zone.classList.add('selected');
            selectedBody = zone.dataset.part;
            log(`üéØ –í—ã –≤—ã–±—Ä–∞–ª–∏: ${selectedBody}`);
        });
    });


    // ====== –ö–ù–û–ü–ö–ê –ê–¢–ê–ö–ò ======
    const attackBtn = document.getElementById('attackBtn');
    attackBtn.onclick = () => {
        if (!wsConnected) {
            log("‚ùå –ù–µ–ª—å–∑—è –∞—Ç–∞–∫–æ–≤–∞—Ç—å: —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.");
            return;
        }
        if (!selectedBody) {
            log("‚ùó –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Å—Ç—å —Ç–µ–ª–∞!");
            return;
        }

        attackBtn.disabled = true;
        ws.send(JSON.stringify({ type: 'attack', body: selectedBody }));
        log(`üïí –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞—Ç–∞–∫–∞ –ø–æ: ${selectedBody}. –ñ–¥—ë–º —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...`);
    };


    // ====== –°–û–ë–´–¢–ò–Ø WEBSOCKET (–°–¢–ê–†–ê–Ø –õ–û–ì–ò–ö–ê) ======
    if (ws) {
        ws.onopen = () => {
            wsConnected = true;
            log(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∫–æ–º–Ω–∞—Ç–µ "${gameCode}" –∫–∞–∫ ${playerName}`);
            ws.send(JSON.stringify({ type: 'join', playerName }));
        };

        ws.onclose = () => {
            wsConnected = false;
            log("üîí –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ");
        };

        ws.onerror = () => {
            wsConnected = false;
            log("‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
        };

        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);

            if (msg.type === 'join') {
                log(`üë§ ${msg.message}`);
                return;
            }
            if (msg.type === 'info') {
                log(`‚ÑπÔ∏è ${msg.message}`);
                return;
            }
            if (msg.type === 'error') {
                log(`‚ùå ${msg.message}`);
                attackBtn.disabled = false;
                return;
            }
            if (msg.type === 'bothSelected') {
                log("‚è≥ –û–±–∞ –∏–≥—Ä–æ–∫–∞ –≤—ã–±—Ä–∞–ª–∏ —Ü–µ–ª–∏, –∏–¥—ë—Ç —Ä–∞—Å—á—ë—Ç –∞—Ç–∞–∫–∏...");
                return;
            }

            // --- –°–¢–ê–†–ê–Ø –õ–û–ì–ò–ö–ê: –∏–≥—Ä–æ–∫–∏ –ù–ï –ú–ï–ù–Ø–Æ–¢–°–Ø –ú–ï–°–¢–ê–ú–ò ---
            if (msg.type === 'UNITS_STATE') {
                const u1 = msg.units[0];
                const u2 = msg.units[1];

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–æ—é –∏ –≤—Ä–∞–∂–µ—Å–∫—É—é —Å—É—â–Ω–æ—Å—Ç—å —Å—Ç–∞—Ä—ã–º —Å–ø–æ—Å–æ–±–æ–º
                const myUnit = u1.player === playerName ? u1 : u2;
                const enemyUnit = u1.player === playerName ? u2 : u1;

                document.getElementById('player1Img').src = myUnit.imagePath;
                document.getElementById('player1Name').textContent = myUnit.player;
                document.getElementById('player1Health').style.width = (myUnit.hp / myUnit.hpMax * 100) + '%';

                document.getElementById('player2Img').src = enemyUnit.imagePath;
                document.getElementById('player2Name').textContent = enemyUnit.player;
                document.getElementById('player2Health').style.width = (enemyUnit.hp / enemyUnit.hpMax * 100) + '%';

                return;
            }

            // --- –ß–ê–¢ (–∫–∞–∫ –≤ —Å—Ç–∞—Ä–æ–º —Å–∫—Ä–∏–ø—Ç–µ) ---
            if (msg.type === 'chat') {
                let inner = null;
                try { inner = JSON.parse(msg.message); } catch {}

                if (inner && inner.turnMessages) {
                    chatMsg("üí• –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—É–Ω–¥–∞:");
                    inner.turnMessages.forEach(m => chatMsg(`‚Üí ${m}`));
                    chatMsg(`‚ù§Ô∏è HP –ü–ª–µ–µ—Ä 1: ${inner.attackerHp}, –ü–ª–µ–µ—Ä 2: ${inner.defenderHp}`);
                    attackBtn.disabled = false;
                    selectedBody = null;
                } else {
                    chatMsg(`${msg.playerName}: ${msg.message}`);
                }
            }
        };
    }

</script>


</body>

</html>
