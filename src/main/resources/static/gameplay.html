<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Duel Test Fixed</title>
    <link rel="stylesheet" href="css/duel-battle.css">

</head>

<body>


<div class="battle-container">
    <div class="unitEntity" id="player1">
        <img id="player1Img" src="" alt="Player 1">
        <div class="health-bar"><div class="health-bar-inner" id="player1Health"></div></div>
        <div id="player1Name">–ü–ª–µ–µ—Ä 1</div>
    </div>
    <div class="unitEntity" id="player2">
        <img id="player2Img" src="" alt="Player 2">
        <div class="health-bar"><div class="health-bar-inner" id="player2Health"></div></div>
        <div id="player2Name">–ü–ª–µ–µ—Ä 2</div>
    </div>
</div>

<!-- –ù–∏–∂–Ω–∏–π –±–æ–ª—å—à–æ–π –±–∞—Ä —Å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π –¥–ª—è –≤—ã–±–æ—Ä–∞ –∞—Ç–∞–∫ -->
<div id="attackSection" style="width: 100%; background: #111; padding: 10px 0; display: flex; justify-content: center; margin-bottom: 10px;">
    <div class="unitEntity" style="position: relative; width: 112px; height: 300px;"> <!-- —É–∂–µ –∏ –¥–ª–∏–Ω–Ω–µ–µ -->
        <img id="attackBody" src="images/body.png" class="body-img" alt="–í—ã–±–æ—Ä –∞—Ç–∞–∫–∏"
             style="width: 100%; height: 100%; object-fit: cover; display: block;"> <!-- —Ä–∞—Å—Ç—è–Ω—É—Ç—å –Ω–∞ –≤–µ—Å—å –±–ª–æ–∫ -->

        <!-- –ó–æ–Ω—ã –ø–æ–ø–∞–¥–∞–Ω–∏—è –Ω–∞ —Ç–µ–ª–µ -->
        <div class="hit-zone" data-part="HEAD" style="top:3px; left:42px; width:22px; height:30px;"></div>
        <div class="hit-zone" data-part="CHEST" style="top:15%; left:37%; width:25%; height:22%;"></div>
        <div class="hit-zone" data-part="LEFT_ARM" style="top:25%; left:6%; width:15%; height:20%;"></div>
        <div class="hit-zone" data-part="RIGHT_ARM" style="top:25%; left:79%; width:15%; height:20%;"></div>
        <div class="hit-zone" data-part="LEFT_LEG" style="top:55%; left:28%; width:18%; height:22%;"></div>
        <div class="hit-zone" data-part="RIGHT_LEG" style="top:55%; left:54%; width:18%; height:22%;"></div>

        <!-- –ö–Ω–æ–ø–∫–∞ –∞—Ç–∞–∫–∏ –ø–æ–¥ –∫–∞—Ä—Ç–∏–Ω–∫–æ–π -->
        <button id="attackBtn" class="action-btn" style="margin-top: 15px; width: 100%; padding: 15px;">‚öîÔ∏è –ê—Ç–∞–∫–æ–≤–∞—Ç—å</button>
    </div>

</div>
<button id="toggleLogBtn" class="log-toggle">‚ò∞ –õ–æ–≥</button>

<div id="log"></div>

<script>
    document.getElementById("toggleLogBtn").onclick = () => {
        document.getElementById("log").classList.toggle("open");
    };
    const params = new URLSearchParams(window.location.search);
    const gameCode = params.get('gameCode') || params.get('id');
    const playerName = params.get('player') || localStorage.getItem('playerName') || `Player${Math.floor(Math.random()*1000)}`;
    localStorage.setItem('playerName', playerName);

    const wsProtocol = location.protocol === 'https:' ? 'wss' : 'ws';
    const ws = new WebSocket(`${wsProtocol}://${location.host}/ws/duel?gameCode=${encodeURIComponent(gameCode)}`);

    let selectedBody = null;
    const logEl = document.getElementById("log");

    function log(msg) {
        const time = new Date().toLocaleTimeString();
        logEl.innerHTML += `<div>[${time}] ${msg}</div>`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    // üéØ –í—ã–±–æ—Ä —á–∞—Å—Ç–∏ —Ç–µ–ª–∞ —á–µ—Ä–µ–∑ –∫–∞—Ä—Ç–∏–Ω–∫—É
    document.querySelectorAll('.hit-zone').forEach(zone => {
        zone.addEventListener('click', () => {
            document.querySelectorAll('.hit-zone').forEach(z => z.classList.remove('selected'));
            zone.classList.add('selected');
            selectedBody = zone.dataset.part;
            log(`üéØ –í—ã –≤—ã–±—Ä–∞–ª–∏: ${selectedBody}`);
        });
    });


    // ‚öîÔ∏è –ö–Ω–æ–ø–∫–∞ –∞—Ç–∞–∫–∏
    const attackBtn = document.getElementById('attackBtn');
    attackBtn.onclick = () => {
        if (!selectedBody) { log("‚ùó –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Å—Ç—å —Ç–µ–ª–∞!"); return; }
        attackBtn.disabled = true;
        ws.send(JSON.stringify({ type: 'attack', body: selectedBody }));
        log(`üïí –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞—Ç–∞–∫–∞ –ø–æ: ${selectedBody}. –ñ–¥—ë–º —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...`);
    };

    // WebSocket —Å–æ–±—ã—Ç–∏—è
    ws.onopen = () => {
        log(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∫–æ–º–Ω–∞—Ç–µ "${gameCode}" –∫–∞–∫ ${playerName}`);
        ws.send(JSON.stringify({ type: 'join', playerName }));
    };

    ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);

        if(msg.type==='join') { log(`üë§ ${msg.message}`); return; }
        if(msg.type==='info') { log(`‚ÑπÔ∏è ${msg.message}`); return; }
        if(msg.type==='error') { log(`‚ùå ${msg.message}`); attackBtn.disabled=false; return; }
        if(msg.type==='bothSelected') { log("‚è≥ –û–±–∞ –∏–≥—Ä–æ–∫–∞ –≤—ã–±—Ä–∞–ª–∏ —Ü–µ–ª–∏, –∏–¥—ë—Ç —Ä–∞—Å—á—ë—Ç –∞—Ç–∞–∫–∏..."); return; }

        if (msg.type === 'UNITS_STATE') {
            const u1 = msg.units[0];
            const u2 = msg.units[1];

            const myUnit = u1.player === playerName ? u1 : u2;
            const enemyUnit = u1.player === playerName ? u2 : u1;

            document.getElementById('player1Img').src = myUnit.imagePath;
            document.getElementById('player1Name').textContent = myUnit.player;
            document.getElementById('player1Health').style.width = (myUnit.hp / myUnit.hpMax * 100) + '%';

            document.getElementById('player2Img').src = enemyUnit.imagePath;
            document.getElementById('player2Name').textContent = enemyUnit.player;
            document.getElementById('player2Health').style.width = (enemyUnit.hp / enemyUnit.hpMax * 100) + '%';
        }

        if(msg.type==='chat'){
            let inner=null;
            try { inner=JSON.parse(msg.message); } catch{}
            if(inner && inner.turnMessages){
                log("üí• –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—É–Ω–¥–∞:");
                inner.turnMessages.forEach(m=>log(`‚Üí ${m}`));
                log(`‚ù§Ô∏è HP –ü–ª–µ–µ—Ä 1: ${inner.attackerHp}, –ü–ª–µ–µ—Ä 2: ${inner.defenderHp}`);
            } else log(`üí¨ ${msg.playerName}: ${msg.message}`);
            attackBtn.disabled=false;
            selectedBody=null;
        }
    };

    ws.onclose = () => log("üîí –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ");
    ws.onerror = (e) => log("‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: " + e.message);
</script>

</body>

</html>
