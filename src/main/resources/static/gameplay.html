<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Duel Test Fixed</title>
    <style>
        body {
            font-family: sans-serif;
            background: #111;
            color: #eee;
            text-align: center;
            padding: 20px;
        }
        .action-btn {
            margin: 5px;
            padding: 10px 15px;
            background: #333;
            border: none;
            border-radius: 6px;
            color: #eee;
            cursor: pointer;
            transition: 0.3s;
        }
        .action-btn:hover:not(:disabled) {
            background: #555;
        }
        .action-btn:disabled {
            background: #222;
            color: #666;
            cursor: not-allowed;
        }
        .battle-container {
            display: flex;
            justify-content: space-around;
            width: 100%;
            max-width: 900px;
            position: relative;
            margin-bottom: 20px;
        }

        .unitEntity {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .unitEntity img {
            width: 150px;
            height: 150px;
            border: 2px solid #fff;
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .health-bar {
            width: 150px;
            height: 20px;
            background: #555;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .health-bar-inner {
            height: 100%;
            background: #ff4b5c;
            width: 100%;
            transition: width 0.3s ease-in-out;
        }

        .hit-zone {
            position: absolute;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0.7;
        }

        .hit-zone.selected {
            outline: 2px solid #6c63ff;
            opacity: 1;
        }

        #log {
            margin-top: 20px;
            width: 100%;
            max-width: 900px;
            min-height: 60px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            font-size: 1em;
        }

    </style>
</head>
<body>

<h2>‚öîÔ∏è Duel Test Client</h2>

<div class="battle-container">
    <div class="unitEntity" id="player1">
        <img id="player1Img" src="" alt="Player 1">
        <div class="health-bar"><div class="health-bar-inner" id="player1Health"></div></div>
        <div id="player1Name">–ü–ª–µ–µ—Ä 1</div>
    </div>
    <div class="unitEntity" id="player2">
        <img id="player2Img" src="" alt="Player 2">
        <div class="health-bar"><div class="health-bar-inner" id="player2Health"></div></div>
        <div id="player2Name">–ü–ª–µ–µ—Ä 2</div>
    </div>
</div>

<div id="attackSection"></div>
<div id="log"></div>

<script>
    const params = new URLSearchParams(window.location.search);
    const gameCode = params.get('gameCode') || params.get('id');
    const playerName = params.get('player') || localStorage.getItem('playerName') || `Player${Math.floor(Math.random()*1000)}`;
    localStorage.setItem('playerName', playerName);

    const wsProtocol = location.protocol === 'https:' ? 'wss' : 'ws';
    const ws = new WebSocket(`${wsProtocol}://${location.host}/ws/duel?gameCode=${encodeURIComponent(gameCode)}`);

    let selectedBody = 'CHEST';
    const logEl = document.getElementById("log");
    const attackSection = document.getElementById("attackSection");

    function log(msg) {
        const time = new Date().toLocaleTimeString();
        logEl.innerHTML += `<div>[${time}] ${msg}</div>`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    // üéØ –ö–Ω–æ–ø–∫–∏ –∞—Ç–∞–∫–∏
    ['HEAD','CHEST','LEFT_ARM','RIGHT_ARM','LEFT_LEG','RIGHT_LEG'].forEach(part => {
        const btn = document.createElement('button');
        btn.textContent = part.replace('_',' ');
        btn.classList.add('action-btn');
        btn.onclick = () => {
            selectedBody = part;
            log(`üéØ –í—ã –≤—ã–±—Ä–∞–ª–∏: ${selectedBody}`);
        };
        attackSection.appendChild(btn);
    });

    // ‚öîÔ∏è –ö–Ω–æ–ø–∫–∞ –∞—Ç–∞–∫–∏
    const attackBtn = document.createElement('button');
    attackBtn.textContent = "‚öîÔ∏è –ê—Ç–∞–∫–æ–≤–∞—Ç—å";
    attackBtn.classList.add('action-btn');
    attackBtn.onclick = () => {
        if (!selectedBody) { log("‚ùó –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Å—Ç—å —Ç–µ–ª–∞!"); return; }
        attackBtn.disabled = true;
        ws.send(JSON.stringify({ type: 'attack', body: selectedBody }));
        log(`üïí –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞—Ç–∞–∫–∞ –ø–æ: ${selectedBody}. –ñ–¥—ë–º —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...`);
    };
    attackSection.appendChild(document.createElement('br'));
    attackSection.appendChild(attackBtn);

    // WebSocket
    ws.onopen = () => {
        log(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∫–æ–º–Ω–∞—Ç–µ "${gameCode}" –∫–∞–∫ ${playerName}`);
        ws.send(JSON.stringify({ type: 'join', playerName }));
    };

    let maxHp = { player1: 100, player2: 100 }; // –¥–µ—Ñ–æ–ª—Ç

    ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);

        // JOIN / INFO / ERROR
        if(msg.type==='join') { log(`üë§ ${msg.message}`); return; }
        if(msg.type==='info') { log(`‚ÑπÔ∏è ${msg.message}`); return; }
        if(msg.type==='error') { log(`‚ùå ${msg.message}`); attackBtn.disabled=false; return; }
        if(msg.type==='bothSelected') { log("‚è≥ –û–±–∞ –∏–≥—Ä–æ–∫–∞ –≤—ã–±—Ä–∞–ª–∏ —Ü–µ–ª–∏, –∏–¥—ë—Ç —Ä–∞—Å—á—ë—Ç –∞—Ç–∞–∫–∏..."); return; }

        // UNITS_STATE
        if (msg.type === 'UNITS_STATE') {
            const u1 = msg.units[0];
            const u2 = msg.units[1];

            const myUnit = u1.player === playerName ? u1 : u2;
            const enemyUnit = u1.player === playerName ? u2 : u1;

            // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–∏ –¥–∞–Ω–Ω—ã–µ
            document.getElementById('player1Img').src = myUnit.imagePath;
            document.getElementById('player1Name').textContent = myUnit.player;
            document.getElementById('player1Health').style.width =
                (myUnit.hp / myUnit.hpMax * 100) + '%';

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–∞–≥–∞
            document.getElementById('player2Img').src = enemyUnit.imagePath;
            document.getElementById('player2Name').textContent = enemyUnit.player;
            document.getElementById('player2Health').style.width =
                (enemyUnit.hp / enemyUnit.hpMax * 100) + '%';
        }


        // CHAT / TURN RESULTS
        if(msg.type==='chat'){
            let inner=null;
            try { inner=JSON.parse(msg.message); } catch{}
            if(inner && inner.turnMessages){
                log("üí• –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—É–Ω–¥–∞:");
                inner.turnMessages.forEach(m=>log(`‚Üí ${m}`));
                log(`‚ù§Ô∏è HP –ü–ª–µ–µ—Ä 1: ${inner.attackerHp}, –ü–ª–µ–µ—Ä 2: ${inner.defenderHp}`);
            } else log(`üí¨ ${msg.playerName}: ${msg.message}`);
            attackBtn.disabled=false;
            selectedBody=null;
        }
    };

    ws.onclose = () => log("üîí –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ");
    ws.onerror = (e) => log("‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: " + e.message);
</script>

</body>
</html>
